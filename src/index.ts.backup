// AI Singer Studio - Main Worker Entry Point

import { Hono } from 'hono';
import { cors } from 'hono/cors';
import { drizzle } from 'drizzle-orm/d1';
import * as schema from './db/schema';
import { authMiddleware } from './middleware/auth';
import { JobManager } from './services/jobs';
import { createGeminiAdapter } from './providers/gemini';
import { createElevenLabsAdapter } from './providers/elevenlabs';
import { createSora2Adapter } from './providers/sora2';
import { createVeo3Adapter } from './providers/veo3';
import { StorageService } from './services/storage';
import type { JobMessage } from './services/jobs';

// Export QuotaManager Durable Object
export { QuotaManager } from './services/quota';

// Types
export interface Env {
  // Bindings
  DB: D1Database;
  ASSETS_BUCKET: R2Bucket;
  VIDEO_HISTORY: KVNamespace;
  SESSIONS: KVNamespace;
  CACHE: KVNamespace;
  JOB_QUEUE: Queue;
  QUOTA_MANAGER: DurableObjectNamespace;
  ANALYTICS: AnalyticsEngineDataset;
  BROWSER?: Fetcher;
  AI: Ai;

  // Secrets
  GEMINI_API_KEY: string;
  ELEVENLABS_API_KEY: string;
  OPENAI_API_KEY?: string;
  VEO3_API_KEY?: string;
  ASSETS_PUBLIC_URL: string;

  // Environment
  ENVIRONMENT: string;
  CLOUDFLARE_ACCOUNT_ID: string;
}

// Create Hono app
const app = new Hono<{ Bindings: Env }>();

// Middleware - CORS with specific origin for credentials
app.use('/*', cors({
  origin: (origin) => {
    // Allow frontend origins
    const allowedOrigins = [
      'https://production.ai-singer-studio-frontend.pages.dev',
      'http://localhost:3000',
      'http://localhost:8788',
    ];
    return allowedOrigins.includes(origin) ? origin : allowedOrigins[0];
  },
  credentials: true,
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowHeaders: ['Content-Type', 'Authorization'],
  exposeHeaders: ['Content-Length', 'X-Request-Id'],
  maxAge: 86400,
}));
app.use('/api/*', authMiddleware);

// Routes
app.get('/', (c) => {
  return c.json({
    service: 'AI Singer Studio',
    version: '2.0.0',
    environment: c.env.ENVIRONMENT
  });
});

// Health check
app.get('/health', (c) => {
  return c.json({ status: 'healthy', timestamp: new Date().toISOString() });
});

// Import API routes
import authRoutes from './api/auth';
// import generateRoutes from './api/generate'; // Temporarily disabled for debugging

app.route('/api/auth', authRoutes);
// app.route('/api/generate', generateRoutes); // Temporarily disabled for debugging

// Queue consumer handler
export async function queue(batch: MessageBatch<JobMessage>, env: Env): Promise<void> {
  const db = drizzle(env.DB, { schema });

  // Initialize providers
  const providers = {
    'gemini-flash': createGeminiAdapter(env.GEMINI_API_KEY),
    'elevenlabs-music': createElevenLabsAdapter(env.ELEVENLABS_API_KEY),
    'sora-2': createSora2Adapter(env.OPENAI_API_KEY || ''),
    'veo3': createVeo3Adapter(env.VEO3_API_KEY || ''),
  };

  // Initialize storage service
  const storage = new StorageService(env.ASSETS_BUCKET, env.ASSETS_PUBLIC_URL);

  // Initialize job manager
  const jobManager = new JobManager(
    db,
    env.JOB_QUEUE,
    providers,
    {
      uploadImage: storage.uploadImage.bind(storage),
      uploadAudio: storage.uploadAudio.bind(storage),
      uploadVideo: storage.uploadVideo.bind(storage),
    }
  );

  // Process each message in the batch
  for (const message of batch.messages) {
    try {
      console.log(`[QUEUE] Processing job: ${message.body.jobId}`);
      await jobManager.processJob(message.body);
      console.log(`[QUEUE] ✅ Job completed: ${message.body.jobId}`);
      message.ack();
    } catch (error) {
      console.error(`[QUEUE] ❌ Job failed: ${message.body.jobId}`, error);
      message.retry();
    }
  }
}

// Export worker with queue handler
export default {
  fetch: app.fetch.bind(app),
  queue,
};
